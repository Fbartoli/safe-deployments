name: Add Chain ID

# Whitelist: Only allow this workflow to run from the specified repositories
# Format: owner/repo-name (e.g., safe-global/safe-deployments)
# Multiple repositories can be added, separated by spaces
# Users: Users who can trigger this workflow from any repository
env:
  ALLOWED_REPOSITORIES: 'safe-global/safe-deployments Fbartoli/safe-deployments Fbartoli/Safe-deployments-scripts'
  ALLOWED_USERS: 'Fbartoli'

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Safe version (e.g., 1.3.0, 1.4.1, 1.5.0)'
        required: true
        type: string
      chain_id:
        description: 'Chain ID to add (e.g., 4326)'
        required: true
        type: string
      deployment_type:
        description: 'Deployment type (canonical, eip155, or zksync)'
        required: true
        type: choice
        options:
          - canonical
          - eip155
          - zksync
      create_pr:
        description: 'Create a pull request with the changes'
        required: true
        type: boolean
        default: true

jobs:
  add-chain-id:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Verify repository and user whitelist
        run: |
          ALLOWED_REPOS="${{ env.ALLOWED_REPOSITORIES }}"
          ALLOWED_USERS="${{ env.ALLOWED_USERS }}"
          CURRENT_REPO="${{ github.repository }}"
          CURRENT_USER="${{ github.actor }}"
          
          # Check if user is in the whitelist (allows triggering from any repo)
          if echo "$ALLOWED_USERS" | grep -qw "$CURRENT_USER"; then
            echo "✅ User verified: $CURRENT_USER (can trigger from any repository)"
          # Check if repository is in the whitelist
          elif echo "$ALLOWED_REPOS" | grep -qw "$CURRENT_REPO"; then
            echo "✅ Repository verified: $CURRENT_REPO"
          else
            echo "❌ Error: This workflow can only be run by:"
            echo "  - Whitelisted users:"
            echo "$ALLOWED_USERS" | tr ' ' '\n' | sed 's/^/    - /'
            echo "  - Or from whitelisted repositories:"
            echo "$ALLOWED_REPOS" | tr ' ' '\n' | sed 's/^/    - /'
            echo ""
            echo "Current user: $CURRENT_USER"
            echo "Current repository: $CURRENT_REPO"
            exit 1
          fi
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Add chain ID
        run: |
          npm run add-chain-id -- \
            --version="${{ inputs.version }}" \
            --chainId="${{ inputs.chain_id }}" \
            --deploymentType="${{ inputs.deployment_type }}" \
            --verbose

      - name: Check for changes
        id: check-changes
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changes detected. Chain ID may already exist."
          fi

      - name: Format JSON files
        if: steps.check-changes.outputs.has_changes == 'true'
        run: npm run lint:fix:json

      - name: Create branch
        if: steps.check-changes.outputs.has_changes == 'true' && inputs.create_pr == true
        run: |
          BRANCH_NAME="add-chainid-${{ inputs.chain_id }}-v${{ inputs.version }}"
          git checkout -b "$BRANCH_NAME"
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_ENV

      - name: Commit changes
        if: steps.check-changes.outputs.has_changes == 'true' && inputs.create_pr == true
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add src/assets/${{ inputs.version }}/*.json
          git commit -m "Add chain ID ${{ inputs.chain_id }} (${{ inputs.deployment_type }}) for Safe ${{ inputs.version }}"

      - name: Push changes
        if: steps.check-changes.outputs.has_changes == 'true' && inputs.create_pr == true
        run: |
          git push origin "$BRANCH_NAME"

      - name: Create Pull Request
        if: steps.check-changes.outputs.has_changes == 'true' && inputs.create_pr == true
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ env.branch_name }}
          title: "Add chain ID ${{ inputs.chain_id }} (${{ inputs.deployment_type }}) for Safe ${{ inputs.version }}"
          body: |
            ## Add new chain

            This PR was automatically created by the GitHub Actions workflow.

            **Chain ID:** ${{ inputs.chain_id }}
            **Safe Version:** ${{ inputs.version }}
            **Deployment Type:** ${{ inputs.deployment_type }}

            Please verify that:
            - The contracts are deployed on the chain
            - The deployment type is correct for this version
            - All contract files have been updated correctly
          labels: |
            automated
          delete-branch: false

      - name: Summary
        if: steps.check-changes.outputs.has_changes == 'false'
        run: |
          echo "## No changes needed" >> $GITHUB_STEP_SUMMARY
          echo "Chain ID ${{ inputs.chain_id }} may already exist with deployment type ${{ inputs.deployment_type }} for version ${{ inputs.version }}." >> $GITHUB_STEP_SUMMARY

      - name: Summary
        if: steps.check-changes.outputs.has_changes == 'true'
        run: |
          echo "## Changes applied" >> $GITHUB_STEP_SUMMARY
          echo "- Added chain ID ${{ inputs.chain_id }} with deployment type ${{ inputs.deployment_type }}" >> $GITHUB_STEP_SUMMARY
          echo "- Version: ${{ inputs.version }}" >> $GITHUB_STEP_SUMMARY
          if [ "${{ inputs.create_pr }}" == "true" ]; then
            echo "- Pull request created: ${{ env.branch_name }}" >> $GITHUB_STEP_SUMMARY
          fi

